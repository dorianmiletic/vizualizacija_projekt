<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>BDP Rast po Regijama | Vizualizacija</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f8f9fa;
    }
    .chart-container {
      height: 500px;
      margin-bottom: 20px;
    }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      pointer-events: none;
      font-size: 14px;
    }
    svg {
      overflow: visible;
    }
    .filter-container {
      margin-top: 20px;
    }
    .form-select {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="row">
      <div class="col-md-9">
        <h3>Prosječni rast BDP-a po regijama (1987–2023)</h3>
        <div id="chart" class="chart-container bg-white shadow rounded p-3"></div>
      </div>
      <div class="col-md-3">
        <h5>O projektu</h5>
        <p>Prikaz prosječnog godišnjeg rasta BDP-a po regijama, s filtriranjem po razini dohotka i godini, koristeći World Bank podatke.</p>
        <p>Izvori: <code>Metadata_Country_API_NY.GDP.MKTP.KD.ZG_DS2_en_csv_v2_85160.csv</code>, <code>API_NY.GDP.MKTP.KD.ZG_DS2_en_csv_v2_85160.csv</code></p>
        <div class="filter-container">
          <h6>Filteri</h6>
          <div>
            <label for="region-select" class="form-label">Odaberi regiju:</label>
            <select id="region-select" class="form-select mb-3" multiple>
              <!-- Popunit će se dinamički -->
            </select>
          </div>
          <div>
            <label for="income-select" class="form-label">Odaberi razinu dohotka:</label>
            <select id="income-select" class="form-select mb-3" multiple>
              <!-- Popunit će se dinamički -->
            </select>
          </div>
          <div>
            <label for="year-select" class="form-label">Odaberi godinu:</label>
            <select id="year-select" class="form-select mb-3">
              <!-- Popunit će se dinamički -->
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="tooltip" id="tooltip" style="opacity: 0;"></div>

  <script>
    const margin = { top: 20, right: 30, bottom: 70, left: 60 };
    const width = 800 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");
    let metadata = [];
    let gdpData = [];
    const startYear = 1987;
    const endYear = 2023;

    // Funkcija za čišćenje podataka
    function cleanData(data, isMetadata) {
      return data.filter(d => {
        if (!d["Country Code"]) return false;
        if (isMetadata) {
          return d["Region"] && d["IncomeGroup"];
        }
        return true;
      }).map(d => {
        const cleaned = { ...d };
        if (!isMetadata) {
          for (let year = startYear; year <= endYear; year++) {
            cleaned[year] = d[year] === "" ? null : +d[year];
          }
        }
        return cleaned;
      });
    }

    // Funkcija za dohvaćanje jedinstvenih vrijednosti
    function getUniqueValues(data, key) {
      return [...new Set(data.map(d => d[key]).filter(d => d))].sort();
    }

    // Funkcija za crtanje grafikona
    function drawChart(selectedRegions, selectedIncomes, selectedYear) {
      svg.selectAll("*").remove();

      // Filtriraj zemlje prema metapodacima
      const validCountryCodes = metadata.map(d => d["Country Code"]);
      const filteredGdpData = gdpData.filter(d => validCountryCodes.includes(d["Country Code"]));

      // Filtriraj prema odabranim regijama i razinama dohotka
      const filteredData = filteredGdpData.filter(d => {
        const meta = metadata.find(m => m["Country Code"] === d["Country Code"]);
        if (!meta) return false;
        const regionMatch = !selectedRegions.length || selectedRegions.includes(meta["Region"]);
        const incomeMatch = !selectedIncomes.length || selectedIncomes.includes(meta["IncomeGroup"]);
        return regionMatch && incomeMatch && d[selectedYear] !== null;
      });

      // Grupiraj po regijama i izračunaj prosjek
      const regionAverages = d3.rollup(
        filteredData,
        v => ({
          avgGrowth: d3.mean(v, d => d[selectedYear]),
          countries: v.length,
          incomeGroups: [...new Set(metadata.filter(m => v.some(d => d["Country Code"] === m["Country Code"])).map(m => m["IncomeGroup"]))]
        }),
        d => metadata.find(m => m["Country Code"] === d["Country Code"])?.["Region"]
      );

      const data = Array.from(regionAverages, ([region, { avgGrowth, countries, incomeGroups }]) => ({
        region,
        avgGrowth,
        countries,
        incomeGroups
      })).filter(d => d.avgGrowth !== undefined);

      if (!data.length) {
        svg.append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .text("Nema podataka za odabrane filtere.");
        return;
      }

      // Postavi skale
      const x = d3.scaleBand()
        .domain(data.map(d => d.region))
        .range([0, width])
        .padding(0.1);

      const y = d3.scaleLinear()
        .domain([d3.min(data, d => d.avgGrowth) - 1, d3.max(data, d => d.avgGrowth) + 1])
        .nice()
        .range([height, 0]);

      // Postavi osi
      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      svg.append("g")
        .call(d3.axisLeft(y).ticks(10, ".1f"));

      // Oznake osi
      svg.append("text")
        .attr("x", width / 2)
        .attr("y", height + margin.bottom - 10)
        .attr("text-anchor", "middle")
        .text("Regija");

      svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", -margin.left + 20)
        .attr("text-anchor", "middle")
        .text("Prosječni rast BDP-a (%)");

      // Crtaj stupce
      svg.selectAll(".bar")
        .data(data)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", d => x(d.region))
        .attr("y", d => y(Math.max(0, d.avgGrowth)))
        .attr("width", x.bandwidth())
        .attr("height", d => Math.abs(y(d.avgGrowth) - y(0)))
        .attr("fill", "steelblue")
        .on("mouseover", function(event, d) {
          d3.select(this).attr("fill", "orange");
          tooltip.transition().duration(200).style("opacity", 0.9);
          tooltip.html(
            `Regija: ${d.region}<br>` +
            `Godina: ${selectedYear}<br>` +
            `Prosječni rast: ${d.avgGrowth.toFixed(2)}%<br>` +
            `Broj zemalja: ${d.countries}<br>` +
            `Razine dohotka: ${d.incomeGroups.join(", ")}`
          )
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function() {
          d3.select(this).attr("fill", "steelblue");
          tooltip.transition().duration(500).style("opacity", 0);
        });
    }

    // Učitavanje podataka i postavljanje filtera
    Promise.all([
      d3.csv("Metadata_Country_API_NY.GDP.MKTP.KD.ZG_DS2_en_csv_v2_85160.csv"),
      d3.csv("API_NY.GDP.MKTP.KD.ZG_DS2_en_csv_v2_85160.csv")
    ]).then(([metaRaw, gdpRaw]) => {
      // Čišćenje podataka
      metadata = cleanData(metaRaw, true);
      gdpData = cleanData(gdpRaw, false);

      // Dohvati jedinstvene regije i razine dohotka
      const regions = getUniqueValues(metadata, "Region");
      const incomeGroups = getUniqueValues(metadata, "IncomeGroup");
      const years = d3.range(startYear, endYear + 1);

      // Popuni filtere
      const regionSelect = d3.select("#region-select");
      regionSelect.selectAll("option")
        .data(regions)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

      const incomeSelect = d3.select("#income-select");
      incomeSelect.selectAll("option")
        .data(incomeGroups)
        .enter()
        .append("option")
        .attr("value", d => d)
        .text(d => d);

      const yearSelect = d3.select("#year-select");
      yearSelect.selectAll("option")
        .data(years)
        .enter()
        .append("option")
        .attr("value", year)
        .text(year => year);

      // Postavi zadatugodinu
      yearSelect.property("value", endYear);

      // Oslušivači za filtere
      function updateChart() {
        const selectedRegions = regionSelect.property("value");
        const selectedIncomes = incomeSelect.property("value");
        const selectedYear = +yearSelect.property("value");
        drawChart(selectedRegions, selectedIncomes, selectedYear);
      }

      regionSelect.on("change", updateChart);
      incomeSelect.on("change", updateChart);
      yearSelect.on("change", updateChart);

      // Inicijalno crtanje
      drawChart([], [], endYear);
    }).catch(error => console.error("Error loading CSV files:", error));
  </script>
</body>
</html>